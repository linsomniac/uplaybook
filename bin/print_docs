#!/usr/bin/env python3

import inspect
import re


def collect_docstrings(module):
    """Collect docstrings from all methods in a module."""
    docstrings = {}

    for name, obj in inspect.getmembers(module):
        if inspect.isfunction(obj) or inspect.ismethod(obj):
            doc = inspect.getdoc(obj)
            if doc:
                docstrings[name] = doc

    return docstrings


def is_taskdoc(doc):
    return "#taskdoc" in doc


if __name__ == "__main__":
    from uplaybook2 import fs, core, internals

    doc_list = []

    for module in fs, core, internals:
        docs = collect_docstrings(module)
        for name, doc in docs.items():
            if not is_taskdoc(doc):
                continue

            mod_name = module.__name__
            mod_name = re.sub(r"^uplaybook2\.", "", mod_name).rstrip()
            doc = re.sub(r"#taskdoc\b", "", doc).rstrip()
            doc = re.sub(
                r"^(Arguments|Examples|Returns):$", r"#### \1:", doc, flags=re.MULTILINE
            )
            doc_list.append(
                (
                    f"{mod_name}.{name}",
                    f"### {mod_name}.{name}:\n\n{doc}\n",
                )
            )

    for name, desc in sorted(doc_list):
        print(desc)
